name: Netlify Preview (fallback)
on:
  workflow_dispatch:
  push:
    branches:
      - fix/minimal-deploy
      - netlify-preview
jobs:
  preview:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
      NETLIFY_SITE_ID:    ${{ secrets.NETLIFY_SITE_ID }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install
        run: npm ci

      - name: Build (Next.js)
        run: npm run build

      # Netlify will auto-detect Next.js and package SSR correctly.
      - name: Deploy to Netlify (preview)
        run: npx netlify-cli deploy --build --message "Preview from GitHub Actions" --json > netlify.json

      - name: Extract Preview URL
        id: extract
        run: |
          PREVIEW_URL=$(cat netlify.json | node -e "process.stdout.write(JSON.parse(require('fs').readFileSync(0,'utf8')).deploy_url || '')")
          echo "url=$PREVIEW_URL" >> $GITHUB_OUTPUT
          echo "Preview URL: $PREVIEW_URL"

      - name: Comment PR with Preview URL
        if: ${{ github.event_name == 'push' }}
        uses: actions/github-script@v7
        with:
          script: |
            const url = '${{ steps.extract.outputs.url }}';
            if (!url) {
              core.setFailed('No Netlify preview URL found.');
            } else if (context.payload.pull_request) {
              await github.rest.issues.createComment({
                issue_number: context.payload.pull_request.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `ðŸŸ¢ Netlify preview is ready: ${url}`
              });
            } else {
              core.info(`Preview URL: ${url}`);
            }
